from utils.bytecode_analyzers.bytecode_to_opcode import get_opcode


def get_external_addresses(instructions_lst):
    """
    :param instructions_lst: list of opcodes (like the one returned by get_opcode in
                                utils.bytecode_analyzers.bytecode_to_opcode

    :return: A set of external addresses referred in the contract
    """
    external_addresses = set()

    for instruction in instructions_lst:
        instruction_components = instruction.split(" ")
        instruction_type = instruction_components[2]

        if instruction_type == "PUSH20":
            address_val = instruction_components[3].split(":")[1]
            if address_val != "0xffffffffffffffffffffffffffffffffffffffff":
                external_addresses.add(address_val)

    return external_addresses


if __name__ == "__main__":
    bytecode = "608060405234801561001057600080fd5b506000735f4ec3df9cbd43714fe2740f5e3616155c5b84199050600073f4030086522a5beea4988f8ca5b36dbc97bee88c905081600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555033600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055505050610939806100d66000396000f3fe6080604052600436106100915760003560e01c8063741bef1a11610059578063741bef1a146101aa5780638da5cb5b146101eb57806398d5fdca1461022c578063b60d428814610257578063dc0d3dff1461026157610091565b806309bc33a7146100965780630d8e6e2c146100c15780633ccfd60b146100ec5780633e47d6f3146100f65780636e5b6b281461015b575b600080fd5b3480156100a257600080fd5b506100ab6102c6565b6040518082815260200191505060405180910390f35b3480156100cd57600080fd5b506100d6610305565b6040518082815260200191505060405180910390f35b6100f46103af565b005b34801561010257600080fd5b506101456004803603602081101561011957600080fd5b81019080803573ffffffffffffffffffffffffffffffffffffffff16906020019092919050505061054f565b6040518082815260200191505060405180910390f35b34801561016757600080fd5b506101946004803603602081101561017e57600080fd5b8101908080359060200190929190505050610567565b6040518082815260200191505060405180910390f35b3480156101b657600080fd5b506101bf610596565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b3480156101f757600080fd5b506102006105bc565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b34801561023857600080fd5b506102416105e2565b6040518082815260200191505060405180910390f35b61025f6106c4565b005b34801561026d57600080fd5b5061029a6004803603602081101561028457600080fd5b8101908080359060200190929190505050610802565b604051808273ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000806802b5e3af16b1880000905060006102df6105e2565b90506000670de0b6b3a76400009050600182828502816102fb57fe5b0401935050505090565b6000600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166354fd4d506040518163ffffffff1660e01b815260040160206040518083038186803b15801561036f57600080fd5b505afa158015610383573d6000803e3d6000fd5b505050506040513d602081101561039957600080fd5b8101908080519060200190929190505050905090565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161461040957600080fd5b3373ffffffffffffffffffffffffffffffffffffffff166108fc479081150290604051600060405180830381858888f1935050505015801561044f573d6000803e3d6000fd5b5060005b6001805490508110156104ee5760006001828154811061046f57fe5b9060005260206000200160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905060008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550508080600101915050610453565b50600067ffffffffffffffff8111801561050757600080fd5b506040519080825280602002602001820160405280156105365781602001602082028036833780820191505090505b506001908051906020019061054c92919061083e565b50565b60006020528060005260406000206000915090505481565b6000806105726105e2565b90506000670de0b6b3a76400008483028161058957fe5b0490508092505050919050565b600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b600080600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663feaf968c6040518163ffffffff1660e01b815260040160a06040518083038186803b15801561064d57600080fd5b505afa158015610661573d6000803e3d6000fd5b505050506040513d60a081101561067757600080fd5b8101908080519060200190929190805190602001909291908051906020019092919080519060200190929190805190602001909291905050505050509150506402540be400810291505090565b60006802b5e3af16b18800009050806106dc34610567565b1015610750576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252601b8152602001807f596f75206e65656420746f207370656e64206d6f72652045544821000000000081525060200191505060405180910390fd5b346000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055506001339080600181540180825580915050600190039060005260206000200160009091909190916101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b6001818154811061080f57fe5b906000526020600020016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b8280548282559060005260206000209081019282156108b7579160200282015b828111156108b65782518260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055509160200191906001019061085e565b5b5090506108c491906108c8565b5090565b5b808211156108ff57600081816101000a81549073ffffffffffffffffffffffffffffffffffffffff0219169055506001016108c9565b509056fea26469706673582212206d3199971d26c263b5bf9f22d583b6dab79ce675856bde1cb8b09c79e56f0da864736f6c634300060c0033"
    instructions = get_opcode(bytecode)
    external_addresses = get_external_addresses(instructions)
    print("\nExternal Addresses referred: ", external_addresses)
